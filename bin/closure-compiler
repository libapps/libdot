#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# Copyright 2019 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

"""Download & run the Closure Compiler.

https://github.com/google/closure-compiler/wiki/Binary-Downloads
"""

from __future__ import print_function

import glob
import os
import sys

import libdot


# The version we currently run.  Pinned to make sure everyone gets consistent
# behavior all the time.
VERSION = '20200406'

# Full path to Google's closure compiler.
URI = 'https://dl.google.com/closure-compiler/compiler-%s.tar.gz' % (VERSION,)


# Where we cache our copy of closure.
CLOSURE = os.path.join(libdot.BIN_DIR, '.closure-compiler.%s.jar' % (VERSION,))


# Where we store externs files.
EXTERNS_DIR = os.path.join(libdot.DIR, 'externs')

# The version of externs that we pull in from closure.  We normally pin to the
# closure version for stability, but this can be updated independently.
EXTERNS_VERSION = VERSION


def update_externs():
    """Update our local cache of externs."""
    URI_TEMPLATE = ('https://github.com/google/closure-compiler/raw/'
                    f'v{EXTERNS_VERSION}/contrib/externs/%(name)s.js')

    for name in ('chrome', 'chrome_extensions'):
        uri = URI_TEMPLATE % {'name': name}
        path = os.path.join(EXTERNS_DIR,
                            f'closure-{name}-v{EXTERNS_VERSION}.js')
        if os.path.exists(path):
            continue

        for oldpath in glob.glob(os.path.join(
                EXTERNS_DIR, f'closure-{name}-v*.js')):
            os.unlink(oldpath)
        libdot.fetch(uri, path)


def update_closure():
    """Update our local cache of Google's closure compiler."""
    if os.path.exists(CLOSURE):
        return

    for path in glob.glob(os.path.join(
            libdot.BIN_DIR, '.closure-compiler.*.jar')):
        os.unlink(path)

    tar = os.path.join(libdot.BIN_DIR, '.closure-compiler.tar')
    libdot.fetch(URI, tar)

    src = 'closure-compiler-v%s.jar' % (VERSION,)
    libdot.unpack(tar, cwd=libdot.BIN_DIR, files=(src,))
    libdot.unlink(tar)
    fullsrc = os.path.join(libdot.BIN_DIR, src)
    # Sometimes the tarball has more restrictive permissions.
    os.chmod(fullsrc, 0o644)
    os.rename(fullsrc, CLOSURE)


def main(argv):
    """The main func!"""
    libdot.setup_logging()

    update_closure()
    update_externs()

    # Run it!
    os.execvp('java', ['java', '-jar', CLOSURE] + argv)


if __name__ == '__main__':
    sys.exit(main(sys.argv[1:]))
